Option Explicit

' 需要引用 Microsoft Scripting Runtime
' 需要导入 VBA-JSON 库 (https://github.com/VBA-tools/VBA-JSON)

Public Function ProcessAndInsertKey(ByRef dict As Object, newKey As String, newValue As String) As Object
    Dim processedDict As Object
    Dim key As Variant
    Dim keyParts() As String
    Dim newKeyNumber As Long
    Dim prevKeyNumber As Long
    Dim nextKeyNumber As Long
    Dim inserted As Boolean
    
    Set processedDict = CreateObject("Scripting.Dictionary")
    
    ' 解析新键的数字部分
    keyParts = Split(newKey, "_")
    If UBound(keyParts) >= 2 Then
        newKeyNumber = CLng(keyParts(1))
    Else
        Err.Raise 5, , "新键格式不正确"
    End If
    
    inserted = False
    prevKeyNumber = -1 ' 初始化为一个不可能的值
    
    ' 遍历原字典，保持原有顺序，并在适当位置插入新键
    For Each key In dict.Keys
        If Left(key, 3) = "pl_" Then
            keyParts = Split(key, "_")
            If UBound(keyParts) >= 2 Then
                nextKeyNumber = CLng(keyParts(1))
                
                ' 检查是否应该在这里插入新键
                If Not inserted And prevKeyNumber < newKeyNumber And newKeyNumber < nextKeyNumber Then
                    processedDict.Add newKey, JsonConverter.ParseJson(newValue)
                    inserted = True
                End If
                
                prevKeyNumber = nextKeyNumber
            End If
        End If
        
        ' 添加原有的键值对
        If IsObject(dict(key)) Then
            Set processedDict(key) = dict(key)
        Else
            processedDict(key) = dict(key)
        End If
    Next key
    
    ' 如果新键比所有现有键都大，则在最后插入
    If Not inserted Then
        processedDict.Add newKey, JsonConverter.ParseJson(newValue)
    End If
    
    Set ProcessAndInsertKey = processedDict
End Function

Sub TestDictionaryProcessing()
    Dim originalDict As Object
    Dim processedDict As Object
    Dim key As Variant
    
    ' 创建原始字典
    Set originalDict = CreateObject("Scripting.Dictionary")
    originalDict.Add "pl_0071_a", "value1"
    originalDict.Add "pl_0100_b", "value2"
    originalDict.Add "other_key", "other_value"
    
    ' 新键和值
    Dim newKey As String
    Dim newValue As String
    newKey = "pl_0080_c"
    newValue = "{""a"": ""b""}"
    
    ' 处理字典并插入新键
    Set processedDict = ProcessAndInsertKey(originalDict, newKey, newValue)
    
    ' 输出处理后的字典
    For Each key In processedDict.Keys
        Debug.Print key & ": " & JsonConverter.ConvertToJson(processedDict(key))
    Next key
End Sub
